# Janssen CRM Dashboard

## نظرة عامة
لوحة تحكم تحليلية لبيانات CRM لشركة Janssen، تتيح تحليل بيانات العملاء والتذاكر والمكالمات وعرضها بطريقة تفاعلية. يستخدم المشروع Streamlit لإنشاء واجهة مستخدم تفاعلية وسهلة الاستخدام، مع تكامل مع Google Drive لتخزين واسترجاع البيانات.

## الميزات الرئيسية
- **تحليل بيانات العملاء**: عرض وتحليل بيانات العملاء مع تحليلات جغرافية وزمنية
- **تحليل التذاكر**: تتبع وتحليل تذاكر الدعم والمشكلات
- **تحليل المكالمات**: تحليل بيانات المكالمات الواردة والصادرة
- **تحليل مكالمات العملاء**: تحليل مفصل للمكالمات حسب العميل
- **تحليل الطلبات**: تحليل طلبات العملاء وتتبعها
- **تحديث البيانات**: تحديث البيانات من قاعدة البيانات إلى Google Drive
- **تصفية البيانات**: أدوات تصفية متقدمة لتحليل مخصص
- **تصور البيانات**: رسوم بيانية وخرائط تفاعلية

## هيكل المشروع

يتكون المشروع من عدة مجلدات وملفات رئيسية، كل منها يخدم غرضًا محددًا:

- `auth/`: يحتوي على وحدات للتحقق من المستخدم وتسجيل الدخول.
  - `authentication.py`: وظائف التحقق من المستخدم.
  - `login.py`: وظائف تسجيل الدخول.
- `filter/`: يحتوي على وحدات لتصفية البيانات وخرائط المعرفات.
  - `data_filter.py`: وظائف تصفية البيانات.
  - `mappings.py`: خرائط المعرفات إلى الأسماء.
- `lode_data/`: مسؤول عن تحميل البيانات من قاعدة البيانات ورفعها إلى Google Drive.
  - `load_database_and_upload_drive.py`: تحديث البيانات من قاعدة البيانات إلى Drive.
  - `load_data_in_drive.py`: تحميل البيانات من Google Drive.
- `pages/`: يحتوي على صفحات تطبيق Streamlit المختلفة.
  - `1_data_management.py`: صفحة إدارة البيانات.
  - `2_dashboard.py`: لوحة التحكم الرئيسية.
  - `3_Customer_Analysis.py`: صفحة تحليل العملاء.
  - `4_Customer_Call_Analysis.py`: صفحة تحليل مكالمات العملاء.
  - `5_Tickets_and_Calls_Analysis.py`: صفحة تحليل التذاكر والمكالمات.
  - `6_Ticket_Items.py`: صفحة عناصر التذاكر.
  - `7_Actions_items_Analysis.py`: صفحة تحليل عناصر الإجراءات.
  - `8_Descriptions_Analysis.py`: صفحة تحليل الأوصاف.
  - `9_Use_Performance_Analysis.py`: صفحة تحليل أداء الاستخدام.
- `process/`: يحتوي على وحدات لمعالجة البيانات والتحليلات.
  - `data_loader.py`: تحميل البيانات المركزي.
  - `data_processor.py`: معالجة البيانات والتحليلات.
  - `error_handler.py`: معالجة الأخطاء.
  - `kpis.py`: حساب مؤشرات الأداء الرئيسية.
  - `table_query.py`: استعلامات الجداول وربطها.
  - `ticket_item_handler.py`: معالجة عناصر التذاكر.
- `visualize/`: يحتوي على وحدات لإنشاء وتصور الرسوم البيانية.
  - `chart_generator.py`: إنشاء الرسوم البيانية.
  - `charts.py`: تعريف أنواع الرسوم البيانية.
  - `data_visualization.py`: وظائف تصور البيانات.
  - `style.py`: أنماط العرض والألوان.
- `client_secret.json`: بيانات اعتماد Google API.
- `requirements.txt`: متطلبات المشروع.
- `login.py`: نقطة الدخول الرئيسية للتطبيق.
- `README.md`: توثيق المشروع.
- `janssencrm_database_schema.md`: وثيقة مخطط قاعدة البيانات.

## تفاصيل مخطط قاعدة البيانات

تم تصميم قاعدة بيانات JanssenCRM لتخزين وإدارة بيانات العملاء، التذاكر، المكالمات، وغيرها من المعلومات المتعلقة بإدارة علاقات العملاء. يتكون المخطط من عدة جداول رئيسية، مع علاقات محددة بينها لضمان تكامل البيانات.

### الجداول الرئيسية والعلاقات

- **جدول العملاء (customers)**:
  - **الأعمدة الرئيسية**: `id` (معرف فريد), `customer_name` (اسم العميل), `created_at` (تاريخ الإنشاء).
  - **العلاقات**: يرتبط بجداول `calls` و `tickets` و `requests` عبر `customer_id`.

- **جدول المكالمات (calls)**:
  - **الأعمدة الرئيسية**: `id` (معرف فريد), `customer_id` (معرف العميل), `call_type` (نوع المكالمة), `call_status` (حالة المكالمة), `created_at` (تاريخ الإنشاء).
  - **العلاقات**: يرتبط بجدول `customers` عبر `customer_id`.

- **جدول التذاكر (tickets)**:
  - **الأعمدة الرئيسية**: `id` (معرف فريد), `customer_id` (معرف العميل), `ticket_status` (حالة التذكرة), `ticket_priority` (أولوية التذكرة), `created_at` (تاريخ الإنشاء).
  - **العلاقات**: يرتبط بجدول `customers` عبر `customer_id`.

- **جدول الطلبات (requests)**:
  - **الأعمدة الرئيسية**: `id` (معرف فريد), `customer_id` (معرف العميل), `request_type` (نوع الطلب), `request_status` (حالة الطلب), `created_at` (تاريخ الإنشاء).
  - **العلاقات**: يرتبط بجدول `customers` عبر `customer_id`.

- **جداول أخرى**: توجد جداول إضافية مثل `users`, `companies`, `governorates`, `cities` التي تدعم الجداول الرئيسية وتوفر بيانات مرجعية.

لمزيد من التفاصيل حول مخطط قاعدة البيانات، يرجى الرجوع إلى ملف `janssencrm_database_schema.md`.

## خطوات التشغيل

لإعداد وتشغيل تطبيق Janssen CRM Dashboard، اتبع الخطوات التالية:

1.  **استنساخ المستودع (Clone the repository)**:
    ```bash
    git clone <repository-url>
    cd C_S
    ```

2.  **إنشاء بيئة افتراضية (Create a virtual environment)**:
    يوصى بشدة بإنشاء بيئة Python افتراضية لعزل تبعيات المشروع.
    ```bash
    python -m venv venv
    ```

3.  **تنشيط البيئة الافتراضية (Activate the virtual environment)**:
    -   **في Windows**:
        ```bash
        .\venv\Scripts\activate
        ```
    -   **في macOS/Linux**:
        ```bash
        source venv/bin/activate
        ```

4.  **تثبيت التبعيات (Install dependencies)**:
    قم بتثبيت جميع المكتبات والمتطلبات اللازمة من ملف `requirements.txt`.
    ```bash
    pip install -r requirements.txt
    ```
    التبعيات الرئيسية تشمل:
    -   `streamlit==1.22.0`
    -   `pandas==1.5.3`
    -   `numpy==1.24.3`
    -   `plotly==5.14.0`
    -   `streamlit-aggrid==0.3.4`
    -   `google-api-python-client`
    -   `google-auth-httplib2`
    -   `google-auth-oauthlib`
    -   `gspread`
    -   `oauth2client`
    -   `psycopg2-binary`
    -   `SQLAlchemy`
    -   `PyYAML`
    -   `python-dotenv`
    -   `watchdog`
    -   `streamlit_option_menu`
    -   `streamlit_extras`
    -   `streamlit_toggle`
    -   `streamlit_card`
    -   `streamlit_lottie`
    -   `streamlit_js_eval`
    -   `streamlit_antd_components`
    -   `streamlit_authenticator`
    -   `streamlit_pandas_profiling`
    -   `streamlit_folium`
    -   `streamlit_drawable_canvas`
    -   `streamlit_cropper`
    -   `streamlit_image_comparison`
    -   `streamlit_timeline`
    -   `streamlit_tags`
    -   `streamlit_player`
    -   `streamlit_pdf_viewer`
    -   `streamlit_ace`
    -   `streamlit_monaco`
    -   `streamlit_quill`
    -   `streamlit_elements`
    -   `streamlit_shadcn_ui`
    -   `streamlit_extras`

5.  **إعداد بيانات اعتماد Google API (Configure Google API Credentials)**:
    تأكد من وجود ملف `client_secret.json` في المجلد الرئيسي للمشروع، والذي يحتوي على بيانات اعتماد Google API للوصول إلى Google Drive.

6.  **تشغيل التطبيق (Run the application)**:
    بعد تثبيت جميع التبعيات وإعداد بيانات الاعتماد، يمكنك تشغيل التطبيق باستخدام الأمر التالي:
    ```bash
    streamlit run login.py
    ```
    سيتم فتح التطبيق في المتصفح الافتراضي على العنوان المحلي (عادةً `http://localhost:8501`).

## التعديلات الأخيرة

### تحسينات هيكلية
- **إعادة تنظيم الكود**: تم إعادة هيكلة الكود لتحسين قابلية الصيانة والتوسع
- **مركزية تحميل البيانات**: تم إنشاء وحدة `data_loader.py` لتوحيد عملية تحميل البيانات من Google Drive
- **تحسين معالجة الأخطاء**: إضافة وحدة `error_handler.py` للتعامل مع الأخطاء بشكل منظم
- **تنظيم وظائف التصور**: تم فصل وظائف إنشاء الرسوم البيانية في ملفات منفصلة لتحسين التنظيم
- **تقليل عدد الصفحات**: تم تقليل عدد الصفحات إلى 5 صفحات (صفحة عامة + 4 صفحات تفصيلية)

### إصلاح الأخطاء
- **معالجة خطأ في تحليل السلاسل الزمنية**: تم إصلاح خطأ في وظيفة `time_series_analysis` حيث تم تسمية العمود الناتج بشكل صريح باسم 'count'
- **تحسين أداء التصفية**: تحسين أداء وظائف التصفية للتعامل مع مجموعات البيانات الكبيرة

## أعمدة البيانات المستخدمة في التحليل

### جدول العملاء (customers)
- **created_at**: تاريخ إنشاء السجل
- **id**: معرف فريد للمكالمة
- **customer_id**: معرف العميل
- **customer_name**: اسم العميل
- **call_type**: نوع المكالمة
- **call_status**: حالة المكالمة
- **call_priority**: أولوية المكالمة
- **call_category**: فئة المكالمة

### جدول التذاكر (ticketcall)
- **created_at**: تاريخ إنشاء التذكرة
- **id**: معرف فريد للتذكرة
- **ticket_status**: حالة التذكرة (مفتوحة، مغلقة، قيد التنفيذ)
- **ticket_priority**: أولوية التذكرة
- **ticket_category**: فئة التذكرة
- **resolution_time**: وقت الحل (بالأيام)

### جدول المكالمات (call)
- **created_at**: تاريخ إنشاء المكالمة
- **id**: معرف فريد للمكالمة
- **call_type**: نوع المكالمة
- **call_status**: حالة المكالمة
- **call_duration**: مدة المكالمة

### جدول الطلبات (request)
- **created_at**: تاريخ إنشاء الطلب
- **id**: معرف فريد للطلب
- **request_type**: نوع الطلب
- **request_status**: حالة الطلب
- **request_priority**: أولوية الطلب

## آلية ربط الملفات والتدفق البياني

### تدفق البيانات
1. **تحميل البيانات**: يبدأ التدفق من `data_loader.py` الذي يقوم بتحميل البيانات من Google Drive
2. **معالجة البيانات**: تتم معالجة البيانات في `data_processor.py` و `table_query.py`
3. **تصفية البيانات**: يتم تطبيق التصفية باستخدام `data_filter.py`
4. **تحليل البيانات**: يتم حساب المقاييس والمؤشرات في `kpis.py`
5. **عرض البيانات**: يتم إنشاء الرسوم البيانية باستخدام `chart_generator.py`

### العلاقات بين الملفات

#### وحدة تحميل البيانات (data_loader.py)
- **الوظيفة**: تحميل جميع الجداول من Google Drive وتخزينها في `st.session_state`
- **الاستدعاء**: يتم استدعاؤها من صفحات التحليل المختلفة
- **المخرجات**: إطارات بيانات Pandas جاهزة للاستخدام

#### وحدة معالجة البيانات (data_processor.py)
- **الوظيفة**: توفير وظائف لمعالجة البيانات وإجراء التحليلات
- **الاستدعاء**: يتم استدعاؤها من صفحات التحليل
- **المدخلات**: إطارات بيانات من `data_loader.py`
- **المخرجات**: بيانات محسوبة ومعالجة

#### وحدة استعلامات الجداول (table_query.py)
- **الوظيفة**: توفير وظائف للاستعلام عن البيانات وتصفيتها
- **الاستدعاء**: يتم استدعاؤها من `data_processor.py` وصفحات التحليل
- **المدخلات**: إطارات بيانات
- **المخرجات**: إطارات بيانات مصفاة

#### وحدة إنشاء الرسوم البيانية (chart_generator.py)
- **الوظيفة**: إنشاء رسوم بيانية مختلفة (دائرية، خطية، شريطية، إلخ)
- **الاستدعاء**: يتم استدعاؤها من صفحات التحليل
- **المدخلات**: بيانات معالجة من `data_processor.py`
- **المخرجات**: رسوم بيانية Plotly جاهزة للعرض

#### صفحات التحليل (pages/*.py)
- **الوظيفة**: عرض واجهة المستخدم وتنسيق عرض البيانات والرسوم البيانية
- **الاستدعاء**: يتم تحميلها من خلال Streamlit
- **المدخلات**: بيانات من `data_loader.py`
- **المعالجة**: استدعاء وظائف من `data_processor.py` و `chart_generator.py`
- **المخرجات**: واجهة مستخدم تفاعلية مع رسوم بيانية وتحليلات

## متطلبات النظام
- Python 3.8 أو أحدث
- Streamlit 1.10.0 أو أحدث
- Pandas 1.3.0 أو أحدث
- Plotly 5.3.0 أو أحدث
- Google API Client

## الإعداد والتثبيت
1. استنساخ المستودع
2. تثبيت المتطلبات: `pip install -r requirements.txt`
3. إعداد بيانات اعتماد Google API وتخزينها في `client_secret.json`

## تشغيل التطبيق
لتشغيل التطبيق، قم بتنفيذ الأمر التالي:
```
streamlit run login.py
```

## دليل الاستخدام
1. تسجيل الدخول باستخدام بيانات الاعتماد المقدمة
2. استخدم شريط التنقل الجانبي للتنقل بين صفحات التحليل المختلفة
3. استخدم أدوات التصفية لتخصيص نطاق البيانات المعروضة
4. استكشف الرسوم البيانية والمقاييس المختلفة في كل صفحة

## ملاحظات
- يتم تخزين البيانات في Google Drive وتحديثها بشكل دوري
- يمكن تحديث البيانات يدويًا باستخدام وظيفة التحديث في التطبيق
- للحصول على أفضل أداء، يوصى باستخدام متصفح حديث
- متطلبات Python المدرجة في `requirements.txt`
- حساب Google مع إمكانية الوصول إلى Google Drive API

## الإعداد والتثبيت

1. استنساخ المستودع:
```bash
git clone <repository-url>
cd C_S
```

2. إنشاء بيئة Python افتراضية وتنشيطها:
```bash
python -m venv venv
# في Windows
venv\Scripts\activate
# في macOS/Linux
source venv/bin/activate
```

3. تثبيت المتطلبات:
```bash
pip install -r requirements.txt
```

4. إعداد بيانات اعتماد Google API:
   - تأكد من وجود ملف `client_secret.json` في المجلد الرئيسي
   - يجب أن يكون لديك إمكانية الوصول إلى Google Drive API

## تشغيل التطبيق

```bash
streamlit run app.py
```

سيتم فتح التطبيق في المتصفح الافتراضي على العنوان المحلي `http://localhost:8501`.

## استخدام التطبيق

1. **تسجيل الدخول**: استخدم بيانات الاعتماد المقدمة للوصول إلى لوحة التحكم
2. **تحديث البيانات**: انقر على زر "تحديث البيانات" لتحديث البيانات من قاعدة البيانات إلى Google Drive
3. **تصفح الصفحات**: استخدم شريط التنقل الجانبي للتنقل بين صفحات التحليل المختلفة
4. **تصفية البيانات**: استخدم أدوات التصفية في كل صفحة لتخصيص التحليلات
5. **تصدير البيانات**: يمكنك تنزيل البيانات المصفاة كملفات CSV من صفحات التحليل

## الملاحظات

- يتم تخزين البيانات في Google Drive للوصول السريع والمشاركة
- يتم تحديث البيانات من قاعدة البيانات يدويًا باستخدام زر "تحديث البيانات"
- يتم تخزين البيانات المحملة في ذاكرة التخزين المؤقت لتحسين الأداء